name: Terraform CI/CD

on:
  push:
    branches:
      -main
  pull_request:
    branches:
      -main

jobs:
  terraform:
    runs-on: ubuntu-latest

  steps:
  - name: 'Checkout github repo'
    uses: actions/checkout@v2
  
  - name: 'AWS credentials'
    uses: aws-actions/configure-aws-credentials@v1
    with:
      aws-access-key-id: ${AWS_ACCESS_KEY_ID}
      aws-secret-access-key: ${AWS_SECRET_ACCESS_KEY}

  - name: 'Setup Terraform'
    uses: hashicorp/setup-terraform@v1
    with:
      aws-access-key-id: 1.8.5
  
  - name: 'Terraform init'
    run: terraform init

  - name: 'Terraform format'
    run: terraform fmt

  - name: 'Terraform plan'
    run: terraform plan

  - name: 'Terraform apply'
    run: terraform apply -auto-approve

